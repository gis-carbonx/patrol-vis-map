<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patrol Data Visualization 7</title>

<!-- Leaflet & Measure -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure@3.3.0/dist/leaflet-measure.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-measure@3.3.0/dist/leaflet-measure.min.js"></script>

<!-- Others -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html, body { height: 100%; margin: 0; overflow: hidden; }
#map { height: 100%; width: 100%; }

#map-title {
  position: absolute; top: 15px; left: 20px; z-index: 1000;
  display: flex; align-items: center; gap: 10px;
  font-family: 'Segoe UI', sans-serif; font-size: 32px; font-weight: 800;
  color: black;
  text-shadow: -2px -2px 0 white, 2px -2px 0 white, -2px 2px 0 white, 2px 2px 0 white;
  pointer-events: none; user-select: none;
}
#map-title img { height: 45px; width: auto; }

.panel {
  position: absolute; z-index: 1000;
  background: rgba(255,255,255,0.95);
  padding: 10px; border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  font-family: 'Segoe UI', sans-serif;
  width: 320px; max-height: 85%; overflow-y: auto;
}
#infoPanel { top: 15px; right: 15px; }
#basemapPanel { bottom: 15px; left: 15px; width: 200px; }
.panel-header {
  font-weight: bold; cursor: pointer; text-align: center;
  background: #444; color: white; padding: 6px; border-radius: 8px;
  margin-bottom: 8px; user-select: none;
}
.panel-content { display: none; }

.leaflet-control-zoom {
  margin-bottom: 10px !important;
  margin-right: 15px !important;
}
.leaflet-control-measure {
  margin-bottom: 65px !important;
  margin-right: 15px !important;
}
.leaflet-control-measure-toggle {
  background-color: #444 !important;
  color: white !important;
  border-radius: 6px !important;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
</style>
</head>

<body>
<div id="map"></div>

<div id="map-title">
  <img src="data/CMI-Brandmark-FullColor-BlackBG.png" alt="Logo CMI">
  <span>Patrol Data Visualization</span>
</div>

<div id="infoPanel" class="panel">
  <div class="panel-header" onclick="togglePanel('infoContent')">Map Statistics ▼</div>
  <div id="infoContent" class="panel-content">
    <p id="totalPoints">Total titik temuan: -</p>
    <canvas id="categoryChart" width="250" height="250"></canvas>
    <button id="resetFilter">Show All</button>
  </div>
</div>

<div id="basemapPanel" class="panel">
  <div class="panel-header" onclick="togglePanel('basemapContent')">Basemap ▼</div>
  <div id="basemapContent" class="panel-content"></div>
</div>

<script>
const basemaps = {
  "OSM": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
  "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
  "Hillshade": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}'),
  "Topo": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png')
};

const map = L.map('map', {
  center: [0.8, 110.325],
  zoom: 13,
  layers: [basemaps["Hillshade"]],
  zoomControl: false
});
L.control.zoom({ position: 'bottomright' }).addTo(map);

// ✅ Fixed: Stable Measure control (no auto zoom)
L.control.measure({
  position: 'bottomright',
  primaryLengthUnit: 'kilometers',
  secondaryLengthUnit: 'meters',
  primaryAreaUnit: 'hectares',
  secondaryAreaUnit: 'sqmeters',
  activeColor: '#f44336',
  completedColor: '#4caf50',
  autoPan: false
}).addTo(map);

// Optional safety: maintain view even after finish measuring
let lastCenter = map.getCenter(), lastZoom = map.getZoom();
map.on('measurestart', () => { lastCenter = map.getCenter(); lastZoom = map.getZoom(); });
map.on('measurefinish', () => { map.setView(lastCenter, lastZoom); });

let currentBase = basemaps["Hillshade"], boundaryLayer = null, markers = [];

fetch('data/CMI.json')
  .then(res => res.json())
  .then(json => {
    boundaryLayer = L.geoJSON(json, { style: { color: "purple", weight: 2, fillOpacity: 0.1 } }).addTo(map);
    if (boundaryLayer.getBounds) map.fitBounds(boundaryLayer.getBounds());
  });

const baseDiv = document.getElementById("basemapContent");
Object.keys(basemaps).forEach(name => {
  const btn = document.createElement("button");
  btn.textContent = name;
  btn.className = 'basemap-btn';
  btn.onclick = () => {
    if (currentBase) map.removeLayer(currentBase);
    currentBase = basemaps[name];
    currentBase.addTo(map);
    if (boundaryLayer && !map.hasLayer(boundaryLayer)) map.addLayer(boundaryLayer);
  };
  baseDiv.appendChild(btn);
});

function togglePanel(id) {
  const el = document.getElementById(id);
  el.style.display = el.style.display === "none" ? "block" : "none";
}
</script>
</body>
</html>
