<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Patrol Data Visualization</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<style>
  html, body, #map { height: 100%; margin: 0; padding: 0; }
  .title {
    position: absolute;
    top: 10px;
    left: 60px;
    z-index: 1000;
    background: rgba(255,255,255,0.85);
    padding: 8px 16px;
    border-radius: 10px;
    font-weight: bold;
    font-size: 16px;
    box-shadow: 0 0 6px rgba(0,0,0,0.3);
  }
  .panel {
    position: absolute;
    top: 60px;
    left: 10px;
    z-index: 1000;
    background: rgba(255,255,255,0.9);
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
    width: 220px;
  }
  .panel h4 { margin: 6px 0; }
  .panel label { font-size: 13px; }
  .toggle-btn {
    background: #5b7bd5;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 5px 10px;
    cursor: pointer;
    margin-bottom: 6px;
  }
  .leaflet-popup-content img {
    width: 250px;
    height: 150px;
    object-fit: cover;
  }
</style>
</head>
<body>
<div class="title">Patrol Data</div>

<div class="panel" id="controlPanel">
  <button class="toggle-btn" onclick="togglePanel()">â˜° Controls</button>
  <div id="panelContent" style="display:none">
    <h4>ðŸ—º Basemap</h4>
    <select id="basemapSelect">
      <option value="osm">OpenStreetMap</option>
      <option value="satellite">Satellite</option>
      <option value="topo">Topographic</option>
    </select>

    <h4>Filter</h4>
    <label>Start Date:</label><br>
    <input type="date" id="startDate"><br>
    <label>End Date:</label><br>
    <input type="date" id="endDate"><br>
    <label>Surveyor:</label><br>
    <input type="text" id="surveyor" placeholder="Type name"><br>
    <button class="toggle-btn" style="margin-top:6px;" onclick="applyFilter()">Apply Filter</button>
    <button class="toggle-btn" style="background:#777;" onclick="resetFilter()">Reset</button>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([-2.2, 112.9], 6);

const baseLayers = {
  "osm": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }),
  "satellite": L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      maxZoom: 20,
      subdomains: ['mt0','mt1','mt2','mt3']
  }),
  "topo": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17 })
};
baseLayers["osm"].addTo(map);

document.getElementById("basemapSelect").addEventListener("change", (e) => {
  Object.values(baseLayers).forEach(layer => map.removeLayer(layer));
  baseLayers[e.target.value].addTo(map);
});

const pinIcon = L.divIcon({
  html: `<div style="position:relative;width:2px;height:20px;background:#e74c3c;margin:0 auto;">
           <div style="width:12px;height:12px;background:#e74c3c;border-radius:50%;position:absolute;top:-8px;left:-5px;border:2px solid white;"></div>
         </div>`,
  className: '',
  iconAnchor: [5, 20],
  popupAnchor: [0, -20]
});

let markers = [];
let patrolData = [];

fetch('https://opensheet.elk.sh/2PACX-1vRKjzBR_BgGYWpnWUvGYzmo4rLbT2iGm2o')
  .then(res => res.json())
  .then(data => {
    patrolData = data;
    renderMarkers(patrolData);
  });

fetch('data/CMI.json')
  .then(res => res.json())
  .then(json => {
    L.geoJSON(json, {
      style: {
        color: 'purple',
        weight: 2,
        fillColor: 'purple',
        fillOpacity: 0.15
      }
    }).addTo(map);
  });

function renderMarkers(data) {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  data.forEach(row => {
    if (!row.Latitude || !row.Longitude) return;
    let lat = parseFloat(row.Latitude);
    let lon = parseFloat(row.Longitude);

    let marker = L.marker([lat, lon], { icon: pinIcon });
    let imgURL = row.Photo ? row.Photo.replace('/open?', '/uc?export=view&') : '';
    let popupHTML = `
      <b>${row.Title || '(No Title)'}</b><br>
      Surveyor: ${row.Surveyor || '-'}<br>
      Date: ${row.Date || '-'}<br>
      <img src="${imgURL}" alt="photo" onerror="this.src='https://via.placeholder.com/250x150?text=Image+Not+Found'">
    `;
    marker.bindPopup(popupHTML);
    marker.addTo(map);
    markers.push(marker);
  });
}

function applyFilter() {
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  const surveyor = document.getElementById('surveyor').value.trim().toLowerCase();

  const filtered = patrolData.filter(row => {
    let date = row.Date ? new Date(row.Date) : null;
    let validDate = (!start || (date && date >= new Date(start))) &&
                    (!end || (date && date <= new Date(end)));
    let validSurveyor = !surveyor || (row.Surveyor && row.Surveyor.toLowerCase().includes(surveyor));
    return validDate && validSurveyor;
  });

  renderMarkers(filtered);
}

function resetFilter() {
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  document.getElementById('surveyor').value = '';
  renderMarkers(patrolData);
}

function togglePanel() {
  let content = document.getElementById("panelContent");
  content.style.display = (content.style.display === "none") ? "block" : "none";
}
</script>
</body>
</html>
