<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patrol Monitoring MapLibre</title>
<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; font-family:'Segoe UI',sans-serif; }
#map { position:absolute; top:0; bottom:0; width:100%; }
#map-title {
  position:absolute; top:15px; left:20px; z-index:1000;
  display:flex; align-items:center; gap:10px;
  font-size:32px; font-weight:800; color:black;
  text-shadow: -2px -2px 0 white, 2px -2px 0 white, -2px 2px 0 white, 2px 2px 0 white;
  pointer-events:none;
}
#map-title img { height:45px; width:auto; }
.panel {
  position:absolute; z-index:1000; background:rgba(255,255,255,0.95);
  padding:10px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.3);
  width:320px; max-height:85%; overflow-y:auto;
}
#infoPanel { top:15px; right:15px; }
#basemapPanel { bottom:15px; left:15px; width:200px; }
.panel-header { font-weight:bold; cursor:pointer; text-align:center;
  background:#444; color:white; padding:6px; border-radius:8px; margin-bottom:8px; user-select:none;
}
.panel-content { display:none; }
#resetFilter {
  background:#555; color:white; border:none; padding:6px 10px; border-radius:6px; margin-top:10px; cursor:pointer; width:100%;
}
#resetFilter:hover { background:#333; }
.basemap-btn {
  display:block; width:100%; margin:3px 0; padding:6px; text-align:left; cursor:pointer;
  border-radius:6px; border:1px solid #ddd; background:#f7f7f7;
}
.basemap-btn:hover { background:#eee; }
.measure-btn {
  background:#444; color:white; border:none; padding:6px 10px; border-radius:6px; margin-bottom:5px; cursor:pointer; width:100%;
}
.measure-btn:hover { background:#222; }

.popup-content img {
  width:100%; max-width:250px; margin-top:8px; border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3); cursor:pointer; transition:transform 0.2s;
}
.popup-content img:hover { transform:scale(1.02); }
.img-modal {
  display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%;
  background:rgba(0,0,0,0.8); justify-content:center; align-items:center;
}
.img-modal img { max-width:90%; max-height:90%; border-radius:10px; }
.img-modal span {
  position:absolute; top:20px; right:40px; color:white;
  font-size:40px; font-weight:bold; cursor:pointer;
}
</style>
</head>
<body>

<div id="map"></div>
<div id="map-title"><img src="data/CMI-Brandmark-FullColor-BlackBG.png" alt="Logo">Patrol Data Visualization</div>

<div id="infoPanel" class="panel">
  <div class="panel-header" onclick="togglePanel('infoContent')">Map Statistics ▼</div>
  <div id="infoContent" class="panel-content">
    <p id="totalPoints">Total titik temuan: -</p>
    <canvas id="categoryChart" width="250" height="250"></canvas>
    <button id="resetFilter">Show All</button>
    <hr>
    <button id="btnMeasure" class="measure-btn">Measure Distance</button>
    <button id="btnUndo" class="measure-btn">Undo Last Point</button>
    <button id="btnClear" class="measure-btn">Clear Measurements</button>
    <div id="legend" style="margin-top:10px;">
      <b>Legend:</b>
      <ul style="list-style:none; padding-left:0; font-size:14px;">
        <li><span style="display:inline-block;width:12px;height:12px;background:orange;margin-right:6px;"></span> Forest Deforestation</li>
        <li><span style="display:inline-block;width:12px;height:12px;background:gray;margin-right:6px;"></span> Non-Forest Deforestation</li>
      </ul>
    </div>
  </div>
</div>

<div id="basemapPanel" class="panel">
  <div class="panel-header" onclick="togglePanel('basemapContent')">Basemap ▼</div>
  <div id="basemapContent" class="panel-content"></div>
</div>

<div id="imageModal" class="img-modal">
  <span id="closeModal">&times;</span>
  <img id="modalImage" src="">
</div>

<script>
function togglePanel(id){ const el=document.getElementById(id); el.style.display=el.style.display==="none"?"block":"none"; }
const modal=document.getElementById("imageModal"), modalImg=document.getElementById("modalImage");
document.getElementById("closeModal").onclick=()=>modal.style.display="none";
modal.onclick=e=>{if(e.target===modal) modal.style.display="none";};

function convertGoogleDriveLink(url){ if(!url) return null; const id=url.match(/[-\w]{25,}/); return id?`https://drive.google.com/thumbnail?id=${id[0]}&sz=w1000`:null; }
function generateColors(n){ const base=['#ff6666','#66b3ff','#99ff99','#ffcc99','#c299ff','#ff99c2','#ffd966','#a1cfff','#b8ffb0','#ffc2d6']; return n<=base.length?base.slice(0,n):Array.from({length:n},(_,i)=>`hsl(${(i*360/n).toFixed(0)} 70% 60%)`); }

const map = new maplibregl.Map({
  container: 'map',
  style: 'https://api.maptiler.com/maps/019a4946-ce24-7a1c-953e-d79c6874ef99/style.json?key=Of0DghNopkV6vp90irfE',
  center: [110.26866, 0.79461],
  zoom: 11
});
map.addControl(new maplibregl.NavigationControl());

let measuring=false, measurePoints=[], measureLine=null;
const btnMeasure=document.getElementById('btnMeasure');
const btnUndo=document.getElementById('btnUndo');
const btnClear=document.getElementById('btnClear');

btnMeasure.onclick=()=>{ measuring=!measuring; btnMeasure.innerHTML=measuring?'Finish Measurement':'Measure Distance'; if(!measuring){ clearStartPoint(); } };
btnUndo.onclick=undoMeasure;
btnClear.onclick=clearMeasurement;

function clearStartPoint(){ if(measureLine) map.removeLayer('measureLine'); measureLine=null; measurePoints=[]; }
function undoMeasure(){ if(measurePoints.length>0){ measurePoints.pop(); drawLine(); } }
function clearMeasurement(){ measurePoints=[]; drawLine(); }

function drawLine(){
  if(map.getLayer('measureLine')) map.removeLayer('measureLine');
  if(map.getSource('measureLine')) map.removeSource('measureLine');
  if(measurePoints.length<2) return;
  map.addSource('measureLine',{type:'geojson',data:{type:'Feature',geometry:{type:'LineString',coordinates:measurePoints}}});
  map.addLayer({id:'measureLine',type:'line',source:'measureLine',layout:{},paint:{'line-color':'red','line-width':3}});
}
map.on('click',(e)=>{
  if(!measuring) return;
  measurePoints.push([e.lngLat.lng,e.lngLat.lat]);
  drawLine();
});

let categoryCount={}, totalPoints=0;
const sheetURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vRKjzBR_BgGYWpnWUvGYzmo4rLbT2iGm2oI1fzjs1wJdPguDpw2UPZXrZQqcXPrGxwJ7PBeDCzHazAj/pub?output=csv";
Papa.parse(sheetURL,{download:true,header:true,complete:(results)=>{
  results.data.forEach(row=>{
    const coord=row['data-coordinate']; if(!coord) return;
    const [lat,lon]=coord.split(',').map(Number); if(isNaN(lat)||isNaN(lon)) return;
    totalPoints++;
    const cat=row['data-survey-categ']||'Unknown';
    categoryCount[cat]=(categoryCount[cat]||0)+1;
    const img1=convertGoogleDriveLink(row['data-documentation-image_1']);
    const img2=convertGoogleDriveLink(row['data-documentation-image_2']);
    const popupHTML=`<div class="popup-content">
      <h2>${cat} - ${row['data-survey-finding']||''}</h2>
      <p><b>Officer:</b> ${row['data-base_info-nama']||''}</p>
      <p><b>Description:</b> ${row['data-survey-description']||''}</p>
      <p><b>Date:</b> ${row['data-start_date']||''}</p>
      ${img1?`<img src="${img1}" onclick="openModal('${img1}')">`:''}
      ${img2?`<img src="${img2}" onclick="openModal('${img2}')">`:''}
    </div>`;
    const el=document.createElement('div'); el.className='marker';
    new maplibregl.Marker(el).setLngLat([lon,lat]).setPopup(new maplibregl.Popup({offset:25}).setHTML(popupHTML)).addTo(map);
  });
  document.getElementById('totalPoints').textContent=`Total titik temuan: ${totalPoints}`;
  const labels=Object.keys(categoryCount), values=Object.values(categoryCount), colors=generateColors(labels.length);
  new Chart(document.getElementById("categoryChart"),{
    type:'pie',
    data:{labels,datasets:[{data:values,backgroundColor:colors}]},
    options:{plugins:{legend:{position:'bottom'}}}
  });
}});

const deforestSheetURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vRY1oLCvdfaMj2T63s2tHUwKm3uZw0ml8CVTiiNut2o0Utr6FHCYbrsPU9zGsaNNvDAUNEXE7o0i3tI/pub?output=csv";
Papa.parse(deforestSheetURL,{download:true,header:true,complete:(results)=>{
  results.data.forEach(row=>{
    const lat=parseFloat(row.latitude), lon=parseFloat(row.longitude);
    if(isNaN(lat)||isNaN(lon)) return;
    const color=row.Class23==='Forest'?'orange':'gray';
    const popupHTML=`<div class="popup-content">
      <h3>Deforestation Detected</h3>
      <p><b>Date:</b> ${row.gfw_integr}</p>
      <p><b>Month:</b> ${row.month}</p>
      <p><b>UMD GLAD:</b> ${row.umd_glad_l||'not_detected'} / ${row.umd_glad_s||'not_detected'}</p>
      <p><b>WUR/RADD:</b> ${row.wur_radd_a||'-'}</p>
      <p><b>Class:</b> ${row.Class23||'-'}</p>
    </div>`;
    const el=document.createElement('div'); el.className='marker';
    el.style.background=color; el.style.width='8px'; el.style.height='8px'; el.style.borderRadius='50%';
    new maplibregl.Marker(el).setLngLat([lon,lat]).setPopup(new maplibregl.Popup({offset:25}).setHTML(popupHTML)).addTo(map);
  });
}});
</script>
</body>
</html>
